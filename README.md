# Разработка интернет-приложений

## Репозиторий для лабораторных работ

# Лабораторная работа №4

## Цель работы

Завершение бэкенда веб-приложения для управления данными археологических артефактов и заявок на расчёт TPQ (Terminus Post Quem) с добавлением авторизации, управления сессиями через Redis, и документации API через Swagger. Реализация ролевого доступа (гость, пользователь, модератор) и тестирование через Insomnia/Postman.

## Задание

Доработка REST API веб-приложения для поддержки аутентификации через сессии и куки, интеграции с Redis для хранения сессий, добавления Swagger-документации, и реализации ролевого доступа. API должно обеспечивать:
- Аутентификацию и регистрацию пользователей с хранением сессий в Redis.
- Автоматическое заполнение creator_id в заявках на основе текущего пользователя.
- Ролевые ограничения: гости — только чтение (GET), пользователи — операции с заявками, модераторы — полный доступ.
- Swagger-документацию для всех эндпоинтов.
- Тестирование через Insomnia/Postman с использованием cookie из браузера/Swagger.

## Порядок показа на защите

### 1. Демонстрация работы API

- **Swagger в режиме инкогнито**:
  - Выполнить POST `/api/login` с корректными учетными данными.
  - Скопировать cookie `session_id` из ответа или вкладки Application браузера.
- **Тестирование через Insomnia/Postman**:
  - Использовать cookie `session_id` в заголовке Cookie или JWT (если применимо) для всех запросов.
  - **GET /api/requests** (без авторизации): Ожидается 401 (Unauthorized) для гостей.
  - **GET /api/requests** (авторизованный пользователь): Получить только свои заявки.
  - **GET /api/requests** (модератор): Получить все заявки с фильтрацией по статусу и датам.
  - **PUT /api/requests/{id}/complete** (пользователь): Ожидается 403 (Forbidden).
  - **PUT /api/requests/{id}/complete** (модератор): Успешное завершение заявки, обновление полей `completed_at`, `moderator_id`, `result` (max TPQ).
  - **GET /api/requests**: Повторно получить список заявок для подтверждения изменений.
- **Redis CLI**:
  - Показать содержимое Redis через команды `KEYS *` и `GET session:<session_id>` для отображения данных сессии (user_id).

### 2. Анализ кода

**Продемонстрировать в коде:**

- **Модели**: ORM-модели (`Artifact`, `TPQRequest`, `TPQRequestItem`, `User`) в `internal/models` с полями для сессий и ролей.
- **Сериализаторы**: JSON-теги в структурах (`json:"field"`) для корректного преобразования данных.
- **Контроллеры**: Реализация REST API в `internal/handlers` с новыми методами для аутентификации (`/api/login`, `/api/logout`, `/api/register`, `/api/me`).
- **Redis для сессий**: Логика хранения сессий в `getUserFromRequest` с использованием Redis (`session:<session_id> → user_id`).
- **Авторизация**: Проверка `getUserFromRequest` во всех защищённых эндпоинтах, возврат 401 при отсутствии сессии.
- **Ролевой доступ**: Проверка `user.IsModerator` для операций модератора (e.g., `CompleteTPQRequest`, `RejectTPQRequest`).
- **Swagger**: Аннотации (`@Summary`, `@Security CookieAuth`, etc.) в хэндлерах для генерации документации.
- **Minio**: Логика загрузки/удаления изображений в `UploadArtifactImage` и `DeleteArtifact`.
- **ORM**: Использование GORM для операций с БД (Find, First, Create, Save, Preload).
- **Фильтрация**: Серверная фильтрация в `GetArtifacts` и `GetTPQRequests` (LIKE, даты).
- **Бизнес-логика**: Ограничения статусов заявок (draft → formed/deleted пользователем; formed → completed/rejected модератором), расчёт TPQ в `CompleteTPQRequest`.
- **Защита системных полей**: Игнорирование `id`, `status`, `creator_id`, `formed_at`, `completed_at`, `moderator_id` из клиентских данных.

### 3. Контрольные вопросы

1. **Куки**: Механизм хранения и передачи, использование в авторизации.
2. **Сессия**: Управление сессиями, их хранение в Redis, время жизни (24 часа).
3. **Redis**: Ключ-значение, команды (`SET`, `GET`, `DEL`, `KEYS`), интеграция с Go.
4. **JWT**: Структура токена, отличия от сессий на основе куки, преимущества/недостатки.
5. **Авторизация и аутентификация**: Различия, применение в REST API.
6. **SSO (Single Sign-On)**: Принципы, примеры реализации.
7. **Двухфакторная аутентификация**: Механизм, примеры (TOTP, SMS).
8. **RSA**: Асимметричное шифрование, использование в HTTPS, JWT подписи.

## Требования к веб-сервису

- **REST API**: Ресурсы: `/api/services`, `/api/requests`, `/api/users`; методы: GET, POST, PUT, DELETE.
- **Авторизация**: Сессии через Redis, cookie `session_id`, 24-часовой срок действия.
- **Ролевой доступ**:
  - Гости: Только GET `/api/services`, `/api/artifacts` (чтение).
  - Пользователи: Создание/редактирование/удаление черновых заявок, добавление артефактов.
  - Модераторы: Полный доступ, включая завершение/отклонение заявок.
- **Swagger**: Полная документация всех эндпоинтов с аннотациями (`@Summary`, `@Security`, etc.).
- **Redis**: Хранение сессий (`session:<uuid> → user_id`).
- **Minio**: Загрузка/удаление изображений артефактов.
- **ORM**: GORM для всех операций с PostgreSQL (Find, First, Create, Save, Preload).
- **Фильтрация**: Серверная фильтрация в GET `/api/services` (name, epoch, TPQ, dates) и GET `/api/requests` (status, formed_at range).
- **Статусы заявок**: draft → formed/deleted (пользователь); formed → completed/rejected (модератор).
- **Системные поля**: Игнорирование `id`, `status`, `creator_id`, `formed_at`, `completed_at`, `moderator_id` из клиентских данных.
- **Исключения**: Записи со status='deleted' не возвращаются.